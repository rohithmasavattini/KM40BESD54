From 3dd5daaf13b85e44c65b2f9f512708b2f7d4a317 Mon Sep 17 00:00:00 2001
From: BodduKishoreKumar <kishore@kernelmasters.org>
Date: Sat, 13 Feb 2021 09:41:31 +0530
Subject: [PATCH] i2c-1 Mux & printf enable

---
 board/ti/am335x/mux.c           | 19 +++++++++++++++----
 cmd/i2c.c                       |  1 +
 drivers/i2c/i2c-uclass-compat.c |  1 +
 drivers/i2c/i2c-uclass.c        |  1 +
 drivers/i2c/omap24xx_i2c.c      | 11 +++++++++--
 5 files changed, 27 insertions(+), 6 deletions(-)

diff --git a/board/ti/am335x/mux.c b/board/ti/am335x/mux.c
index 0d37bd9f..7a665b99 100644
--- a/board/ti/am335x/mux.c
+++ b/board/ti/am335x/mux.c
@@ -95,12 +95,26 @@ static struct module_pin_mux mii1_pin_mux[] = {
 	{-1},
 };
 
+static struct module_pin_mux i2c1_pin_mux[] = {
+	{OFFSET(spi0_d1), (MODE(2) | RXACTIVE |
+			PULLUDEN | SLEWCTRL)}, /* I2C_DATA */
+	{OFFSET(spi0_cs0), (MODE(2) | RXACTIVE |
+			PULLUDEN | SLEWCTRL)}, /* I2C_SCLK */
+	{-1},
+};
+
+void enable_i2c1_pin_mux(void)
+{
+        configure_module_pin_mux(i2c1_pin_mux);
+}
+
 void km_bbb_mux(void)
 {
 	 configure_module_pin_mux(mmc0_pin_mux);
 	 configure_module_pin_mux(mmc1_pin_mux);
 	 configure_module_pin_mux(lcd_pin_mux);
          configure_module_pin_mux(mii1_pin_mux);
+         configure_module_pin_mux(i2c1_pin_mux);
 }
 
 void enable_board_pin_mux(void)
@@ -311,10 +325,7 @@ void enable_i2c0_pin_mux(void)
 }
 
 
-void enable_i2c1_pin_mux(void)
-{
-        //configure_module_pin_mux(i2c1_pin_mux);
-}
+
 void enable_i2c2_pin_mux(void)
 {
 //	configure_module_pin_mux(i2c2_pin_mux);
diff --git a/cmd/i2c.c b/cmd/i2c.c
index 09c4ba9a..eb43b8eb 100644
--- a/cmd/i2c.c
+++ b/cmd/i2c.c
@@ -962,6 +962,7 @@ static int do_i2c_probe (cmd_tbl_t *cmdtp, int flag, int argc, char * const argv
 		return CMD_RET_FAILURE;
 #endif
 
+	printf("%s:%s:%d\n",__FILE__,__func__,__LINE__);
 	if (argc == 2)
 		addr = simple_strtol(argv[1], 0, 16);
 
diff --git a/drivers/i2c/i2c-uclass-compat.c b/drivers/i2c/i2c-uclass-compat.c
index b3ade881..98290772 100644
--- a/drivers/i2c/i2c-uclass-compat.c
+++ b/drivers/i2c/i2c-uclass-compat.c
@@ -34,6 +34,7 @@ int i2c_probe(uint8_t chip_addr)
 	struct udevice *bus, *dev;
 	int ret;
 
+	printf("%s:%s:%d\n",__FILE__,__func__,__LINE__);
 	ret = uclass_get_device_by_seq(UCLASS_I2C, cur_busnum, &bus);
 	if (ret) {
 		debug("Cannot find I2C bus %d: err=%d\n", cur_busnum, ret);
diff --git a/drivers/i2c/i2c-uclass.c b/drivers/i2c/i2c-uclass.c
index 49e23a0a..9cc0e522 100644
--- a/drivers/i2c/i2c-uclass.c
+++ b/drivers/i2c/i2c-uclass.c
@@ -253,6 +253,7 @@ static int i2c_probe_chip(struct udevice *bus, uint chip_addr,
 	struct i2c_msg msg[1];
 	int ret;
 
+	printf("%s:%s:%d\n",__FILE__,__func__,__LINE__);
 	if (ops->probe_chip) {
 		ret = ops->probe_chip(bus, chip_addr, chip_flags);
 		if (!ret || ret != -ENOSYS)
diff --git a/drivers/i2c/omap24xx_i2c.c b/drivers/i2c/omap24xx_i2c.c
index 4b93e02b..523dab57 100644
--- a/drivers/i2c/omap24xx_i2c.c
+++ b/drivers/i2c/omap24xx_i2c.c
@@ -255,6 +255,8 @@ static u16 wait_for_event(void __iomem *i2c_base, int ip_rev, int waitdelay)
 	int timeout = I2C_TIMEOUT;
 	int irq_stat_reg;
 
+	printf("%s:%s:%d\n",__FILE__,__func__,__LINE__);
+	printf("%d\n",waitdelay);
 	irq_stat_reg = (ip_rev == OMAP_I2C_REV_V1) ?
 		       OMAP_I2C_STAT_REG : OMAP_I2C_IP_V2_IRQSTATUS_RAW;
 	do {
@@ -483,6 +485,7 @@ static int __omap24_i2c_probe(void __iomem *i2c_base, int ip_rev, int waitdelay,
 	u16 status;
 	int res = 1; /* default = fail */
 
+	printf("%s:%s:%d\n",__FILE__,__func__,__LINE__);
 	if (chip == omap_i2c_read_reg(i2c_base, ip_rev, OMAP_I2C_OA_REG))
 		return res;
 
@@ -552,7 +555,7 @@ static int __omap24_i2c_read(void __iomem *i2c_base, int ip_rev, int waitdelay,
 {
 	int i2c_error = 0;
 	u16 status;
-
+	uchar temp;
 	if (alen < 0) {
 		puts("I2C read: addr len < 0\n");
 		return 1;
@@ -681,8 +684,11 @@ static int __omap24_i2c_read(void __iomem *i2c_base, int ip_rev, int waitdelay,
 			goto rd_exit;
 		}
 		if (status & I2C_STAT_RRDY) {
-			*buffer++ = omap_i2c_read_reg(i2c_base, ip_rev,
+			temp = omap_i2c_read_reg(i2c_base, ip_rev,
 						      OMAP_I2C_DATA_REG);
+			printf("buffer:%x\n",temp);
+			*buffer++ = temp; 
+
 			omap_i2c_write_reg(i2c_base, ip_rev,
 					   I2C_STAT_RRDY, OMAP_I2C_STAT_REG);
 		}
@@ -1040,6 +1046,7 @@ static int omap_i2c_probe_chip(struct udevice *bus, uint chip_addr,
 {
 	struct omap_i2c *priv = dev_get_priv(bus);
 
+	printf("%s:%s:%d\n",__FILE__,__func__,__LINE__);
 	return __omap24_i2c_probe(priv->regs, priv->ip_rev, priv->waitdelay,
 				  chip_addr);
 }
-- 
2.17.1

